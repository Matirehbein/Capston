<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestionar Imágenes - {{ producto.nombre_producto }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos para el efecto de lupa/zoom */
        .image-zoom-container {
            position: relative;
            width: 150px;
            height: 150px;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }
        .image-zoom-container .zoom-image {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: 250%;
            background-position: center center;
            background-repeat: no-repeat;
            pointer-events: none;
        }
        /* Estilos para el botón de eliminar imagen */
        .delete-img-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Gestionar Imágenes</h2>
            <h4>{{ producto.nombre_producto }}</h4>
            <span class="badge bg-dark">ID: {{ producto.id_producto }}</span>
            <span class="badge bg-info text-dark">SKU: {{ producto.sku }}</span>
        </div>
        <a href="{{ url_for('crud_productos') }}" class="btn btn-dark">Volver al listado</a>
    </div>

    <div class="text-center mb-4">
        <img src="{{ producto.imagen_url or 'https://via.placeholder.com/300' }}" class="img-fluid rounded border" style="max-height: 300px;" alt="Imagen Principal">
    </div>

    <div class="card">
        <div class="card-body">
            <form action="{{ url_for('guardar_imagenes', id_producto=producto.id_producto) }}" method="POST">
                
                <h5>Imagen Principal</h5>
                <div class="input-group mb-3">
                    <input type="text" id="imagen_principal_input" class="form-control" name="imagen_principal" placeholder="URL de la imagen principal" value="{{ producto.imagen_url or '' }}">
                </div>

                <hr>

                <h5>Imágenes Adicionales (hasta 4)</h5>
                {% set imagenes_existentes = imagenes_adicionales | map(attribute='url_imagen') | list %}
                {% for i in range(4) %}
                    <div class="input-group mb-2">
                        <span class="input-group-text">#{{ i + 2 }}</span>
                        <input type="text" id="imagen_adicional_input_{{ i }}" class="form-control" name="imagenes_adicionales[]" placeholder="URL de imagen adicional" value="{{ imagenes_existentes[i] if imagenes_existentes|length > i else '' }}">
                    </div>
                {% endfor %}

                <button type="submit" class="btn btn-primary mt-3 w-100">Guardar Todas las Imágenes</button>
            </form>
        </div>
    </div>

    <h4 class="mt-5">Vista Previa (Haz clic para ampliar)</h4>
    <div class="d-flex flex-wrap gap-3 mb-5">
        <div class="image-zoom-container" data-input-id="imagen_principal_input">
            <button type="button" class="delete-img-btn">&times;</button>
            <div class="zoom-image" style="background-image: url('{{ producto.imagen_url or 'https://via.placeholder.com/150' }}');"></div>
        </div>
        {% for i in range(4) %}
        <div class="image-zoom-container" data-input-id="imagen_adicional_input_{{ i }}">
            <button type="button" class="delete-img-btn">&times;</button>
            <div class="zoom-image" style="background-image: url('{{ imagenes_existentes[i] if imagenes_existentes|length > i else 'https://via.placeholder.com/150' }}');"></div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="imageLightbox" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="lightboxImage" src="" class="img-fluid" alt="Vista ampliada">
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const containers = document.querySelectorAll('.image-zoom-container');
    const lightboxModal = new bootstrap.Modal(document.getElementById('imageLightbox'));
    const lightboxImage = document.getElementById('lightboxImage');
    const placeholderUrl = 'https://via.placeholder.com/150';

    containers.forEach(container => {
        const zoomImage = container.querySelector('.zoom-image');
        const deleteBtn = container.querySelector('.delete-img-btn');
        const inputId = container.dataset.inputId;
        const linkedInput = document.getElementById(inputId);

        // --- Funcionalidad de Lupa/Zoom ---
        container.addEventListener('mousemove', function (e) {
            const rect = container.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;
            zoomImage.style.backgroundPosition = `${x * 100}% ${y * 100}%`;
        });
        container.addEventListener('mouseleave', function () {
            zoomImage.style.backgroundPosition = 'center center';
        });

        // --- Funcionalidad de Eliminar Imagen ---
        deleteBtn.addEventListener('click', function (e) {
            e.stopPropagation(); // Evita que se abra el lightbox al hacer clic en la X
            if (linkedInput) {
                linkedInput.value = ''; // Borra el contenido del input
            }
            zoomImage.style.backgroundImage = `url('${placeholderUrl}')`; // Muestra la imagen placeholder
        });

        // --- Funcionalidad de Click para Ampliar (Lightbox) ---
        container.addEventListener('click', function (e) {
            // Solo abre el lightbox si se hace clic en el contenedor y no en el botón de borrar
            if (e.target === container || e.target === zoomImage) {
                let imageUrl = zoomImage.style.backgroundImage.slice(5, -2); // Extrae la URL del estilo
                if (imageUrl && imageUrl !== placeholderUrl) {
                    lightboxImage.src = imageUrl;
                    lightboxModal.show();
                }
            }
        });
    });
});
</script>

</body>
</html>