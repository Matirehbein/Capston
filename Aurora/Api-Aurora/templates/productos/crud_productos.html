<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title> Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/crud_productos.css') }}" rel="stylesheet">

    <style>
        /* Marco y fondo piel para formularios y tablas */
        .marco-piel {
            border: 2px solid #ffdbc4;
            border-radius: 8px;
            padding: 15px;
            background-color: #ffdbc4;
        }
        .marco-piel h2 {
            margin-top: 0;
        }
    </style>
</head>

<body class="bg-light">

<div class="sidebar">
    <h2 class="sidebar-title">Aurora Admin</h2>
    <ul class="sidebar-menu">
        <li><a href="{{ url_for('crud_sucursales') }}">CRUD Sucursales</a></li>
        <li><a href="{{ url_for('crud_productos') }}">CRUD Productos</a></li>
        <li><a href="{{ url_for('crud_usuarios') }}">CRUD Usuarios</a></li>
        <li><a href="{{ url_for('crud_ofertas') }}">CRUD Ofertas</a></li>
        <li><a href="#">Reportes</a></li>
        <li><a href="#">Configuración</a></li>
    </ul>
    <div class="sidebar-footer">
      <a href="{{ url_for('index_options') }}" class="btn btn-secondary w-100">Menú Principal</a>
    </div>
</div>


<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Productos</h1>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-3" role="alert">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('crud_productos') }}" method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="q" class="form-label">ID o SKU</label>
                    <input type="text" name="q" id="q" class="form-control" placeholder="Buscar..." value="{{ filtros_activos.q }}">
                </div>
                
                <div class="col-md-3">
                    <label for="filtro_categoria" class="form-label">Categoría</label>
                    <select name="filtro_categoria" id="filtro_categoria" class="form-select">
                        <option value="">Todas</option>
                        {% for cat in categorias %}
                            <option value="{{ cat }}" {{ 'selected' if cat == filtros_activos.categoria }}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label for="filtro_nombre" class="form-label">Nombre</label>
                    <select name="filtro_nombre" id="filtro_nombre" class="form-select">
                        <option value="">Todos</option>
                        {% for nombre in nombres_productos %}
                             <option value="{{ nombre }}" {{ 'selected' if nombre == filtros_activos.nombre }}>{{ nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label for="filtro_sucursal" class="form-label">Sucursal</label>
                    <select name="filtro_sucursal" id="filtro_sucursal" class="form-select">
                        <option value="">Todas</option>
                         {% for s in sucursales %}
                            <option value="{{ s.id_sucursal }}" {{ 'selected' if s.id_sucursal|string == filtros_activos.sucursal }}>{{ s.nombre_sucursal }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2 d-flex">
                    <button type="submit" class="btn btn-primary me-2">Filtrar</button>
                    <a href="{{ url_for('crud_productos') }}" class="btn btn-secondary">Limpiar</a>
                </div>
            </form>
        </div>
    </div>
    <div class="marco-piel mb-5">
        <h2>Agregar Producto</h2>
        <form action="{{ url_for('add_producto') }}" method="post" class="row g-3">
            <div class="col-md-4">
                <label for="sku_digits" class="form-label">SKU</label>
                <div class="input-group">
                    <span class="input-group-text">AUR-</span>
                    <input type="text" class="form-control" id="sku_digits" name="sku_digits" placeholder="00001" required maxlength="5" pattern="[0-9]{5}" title="Debe ingresar 5 dígitos numéricos.">
                </div>
            </div>
            <div class="col-md-8">
                <label for="nombre" class="form-label">Nombre del Producto</label>
                <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ej: Polera Básica" required>
            </div>
            <div class="col-md-4">
                <label for="precio" class="form-label">Precio</label>
                <input type="number" step="1" class="form-control" id="precio" name="precio" placeholder="Ej: 10000" required>
            </div>
            <div class="col-md-4">
                <label for="categoria_producto" class="form-label">Categoría</label>
                <select name="categoria" id="categoria_producto" class="form-select" required>
                    <option value="" selected disabled>Selecciona una categoría...</option>
                    <option value="Abrigos">Abrigos</option>
                    <option value="Accesorios">Accesorios</option>
                    <option value="Calzado">Calzado</option>
                    <option value="Chaquetas">Chaquetas</option>
                    <option value="Joyas">Joyas</option>
                    <option value="Pantalones">Pantalones</option>
                    <option value="Parkas">Parkas</option>
                    <option value="Polerones">Polerones</option>
                    <option value="Poleras">Poleras</option>
                    <option value="Ropa interior">Ropa interior</option>
                    <option value="Top">Top</option>
                    <option value="Traje de baño">Traje de baño</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="color_producto" class="form-label">Color</label>
                <select name="color" id="color_producto" class="form-select" required>
                    <option value="" selected disabled>Selecciona un color...</option>
                    <option value="Rojo">Rojo</option>
                    <option value="Azul">Azul</option>
                    <option value="Verde">Verde</option>
                    <option value="Negro">Negro</option>
                    <option value="Blanco">Blanco</option>
                    <option value="Gris">Gris</option>
                    <option value="Amarillo">Amarillo</option>
                    <option value="Rosado">Rosado</option>
                    <option value="Morado">Morado</option>
                    <option value="Naranjo">Naranjo</option>
                    <option value="Café">Café</option>
                </select>
            </div>
            <div class="col-md-12">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea class="form-control" id="descripcion" name="descripcion" placeholder="Descripción del producto"></textarea>
            </div>
            <div class="col-md-12">
                <label for="imagen_url" class="form-label">URL de la Imagen</label>
                <input type="text" class="form-control" id="imagen_url" name="imagen_url" placeholder="https://ejemplo.com/imagen.jpg">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-success w-100">Agregar Producto</button>
            </div>
        </form>
    </div>

    <div class="marco-piel mb-5">
        <h2>Listado de Productos</h2>
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>SKU</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Imagen</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr>
                    <td>{{ p.id_producto }}</td>
                    <td>{{ p.sku }}</td>
                    <td>{{ p.nombre_producto }}</td>
                    <td>${{ "%.2f"|format(p.precio_producto) }}</td>
                    <td>{{ p.descripcion_producto or "-" }}</td>
                    <td>{{ p.categoria_producto or "-" }}</td>
                    <td>
                        {% if p.imagen_url %}
                            <img src="{{ p.imagen_url }}" alt="Imagen producto" style="width:60px; height:auto;">
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ p.stock if p.stock else 0 }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editProductoModal{{p.id_producto}}">Editar Producto</button>
                        <form action="{{ url_for('delete_producto', id=p.id_producto) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                        </form>
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#stockModal{{p.id_producto}}">Editar Stock</button>
                        <a href="{{ url_for('ver_stock', id_producto=p.id_producto) }}" class="btn btn-sm btn-info">Ver Stock</a>
                    </td>
                </tr>

                <div class="modal fade" id="editProductoModal{{p.id_producto}}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form action="{{ url_for('edit_producto', id=p.id_producto) }}" method="post">
                        <div class="modal-header">
                          <h5 class="modal-title">Editar Producto</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-2">
                            <label class="form-label">SKU</label>
                            <input type="text" class="form-control" name="sku" value="{{ p.sku }}" required>
                          </div>
                          <div class="mb-2">
                            <label class="form-label">Nombre del Producto</label>
                            <input type="text" class="form-control" name="nombre" value="{{ p.nombre_producto }}" required>
                          </div>
                          <div class="mb-2">
                            <label class="form-label">Precio</label>
                            <input type="number" step="0.01" class="form-control" name="precio" value="{{ p.precio_producto }}" required>
                          </div>
                          <div class="mb-2">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" name="descripcion" placeholder="Descripción">{{ p.descripcion_producto }}</textarea>
                          </div>
                          <div class="mb-2">
                            <label class="form-label">Categoría</label>
                            <input type="text" class="form-control" name="categoria" value="{{ p.categoria_producto }}">
                          </div>
                          <div class="mb-2">
                            <label class="form-label">URL de la imagen</label>
                            <input type="text" class="form-control" name="imagen_url" value="{{ p.imagen_url }}" placeholder="URL de la imagen">
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <div class="modal fade" id="stockModal{{p.id_producto}}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form action="{{ url_for('edit_stock', id=p.id_producto) }}" method="post">
                        <div class="modal-header">
                          <h5 class="modal-title">Editar Stock</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <label for="sucursal">Sucursal</label>
                          <select name="id_sucursal" class="form-control mb-2" required>
                            {% for s in sucursales %}
                              <option value="{{ s.id_sucursal }}">{{ s.nombre_sucursal }}</option>
                            {% endfor %}
                          </select>
                          <input type="number" class="form-control mb-2" name="stock" placeholder="Nuevo stock" required>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-warning">Guardar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('filtro_categoria');
    const nombreSelect = document.getElementById('filtro_nombre');
    const nombreOriginalSeleccionado = "{{ filtros_activos.nombre or '' }}";

    categoriaSelect.addEventListener('change', function() {
        actualizarNombres(this.value);
    });

    function actualizarNombres(categoria) {
        const url = `/api/productos/nombres_por_categoria?categoria=${encodeURIComponent(categoria)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                nombreSelect.innerHTML = '<option value="">Todos</option>';
                data.nombres.forEach(nombre => {
                    const option = document.createElement('option');
                    option.value = nombre;
                    option.textContent = nombre;
                    if (nombre === nombreOriginalSeleccionado && categoria === "{{ filtros_activos.categoria or '' }}") {
                        option.selected = true;
                    }
                    nombreSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error al cargar los nombres:', error));
    }
});
</script>

</body>
</html>