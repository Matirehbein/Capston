<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer Contraseña | Aurora</title>
  <link rel="stylesheet" href="/Public/Css/login.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <style>
    /* Reutilizando estilos del login */
    body { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; background-color: #f4f4f4; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .box { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 90%; }
    h2 { text-align: center; margin-bottom: 20px; color: #333; }
    .input-group { position: relative; margin-bottom: 20px; }
    .input-group input { width: 100%; padding: 12px 15px 12px 45px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
    .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
    button { width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 15px; cursor: pointer; background-color: #333; color: white; border: none; border-radius: 4px;}
    button:hover { background-color: #555; }

    /* Validación Password */
    .password-rules { font-size: 0.85em; margin-top: 5px; }
    .rule { color: red; transition: color 0.3s; }
    .rule.valid { color: green; }
    .strength-bar { height: 6px; width: 100%; background: #ddd; border-radius: 4px; margin-top: 8px; }
    .strength-fill { height: 100%; width: 0; border-radius: 4px; transition: width 0.3s, background 0.3s; }
    .strength-text { font-size: 0.85em; margin-top: 3px; text-align: right; }
    .error-msg { color: red; font-size: 0.9em; margin-bottom: 15px; text-align: center; display: none; }

    /* --- SOLUCIÓN AL PROBLEMA --- */
    /* Forzamos que ESTE formulario se vea, ignorando el ocultamiento de login.css */
    #resetForm {
        display: block !important;
    }
  </style>
</head>
<body>

<div class="box">
    <h2>Nueva Contraseña</h2>
    <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em;">Ingresa tu nueva contraseña para recuperar el acceso.</p>
    
    <div id="global-error" class="error-msg"></div>

    <form id="resetForm">
        <div class="input-group">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="password" placeholder="Nueva contraseña" required>
        </div>
        
        <div class="password-validation-area">
            <div class="password-rules">
              <div id="rule-length" class="rule"><i class="fas fa-circle" style="font-size: 6px; vertical-align: middle;"></i> 6–24 caracteres</div>
              <div id="rule-uppercase" class="rule"><i class="fas fa-circle" style="font-size: 6px; vertical-align: middle;"></i> Al menos una mayúscula</div>
              <div id="rule-number" class="rule"><i class="fas fa-circle" style="font-size: 6px; vertical-align: middle;"></i> Al menos un número</div>
              <div id="rule-special" class="rule"><i class="fas fa-circle" style="font-size: 6px; vertical-align: middle;"></i> Al menos un carácter especial</div>
            </div>
            <div class="strength-bar"><div id="strength-fill" class="strength-fill"></div></div>
            <div id="strength-text" class="strength-text">Débil</div>
        </div>

        <div class="input-group" style="margin-top: 20px;">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="password_confirm" placeholder="Repetir contraseña" required>
        </div>
        <div id="match-error" style="color: red; font-size: 0.85em; display: none; margin-bottom: 10px; text-align: center;">Las contraseñas no coinciden.</div>

        <button type="submit">Actualizar Contraseña</button>
    </form>
</div>

<script>
    const token = "{{ token }}";
    
    const passInput = document.getElementById('password');
    const confirmInput = document.getElementById('password_confirm');
    const matchError = document.getElementById('match-error');
    const globalError = document.getElementById('global-error');
    const form = document.getElementById('resetForm');
    
    // Reglas
    const ruleLength = document.getElementById("rule-length");
    const ruleUppercase = document.getElementById("rule-uppercase");
    const ruleNumber = document.getElementById("rule-number");
    const ruleSpecial = document.getElementById("rule-special");
    const strengthFill = document.getElementById("strength-fill");
    const strengthText = document.getElementById("strength-text");

    let passwordIsValid = false;

    passInput.addEventListener('input', () => {
        const val = passInput.value;
        let score = 0;
        passwordIsValid = true;

        if (val.length >= 6 && val.length <= 24) { ruleLength.classList.add("valid"); score++; }
        else { ruleLength.classList.remove("valid"); passwordIsValid = false; }

        if (/[A-Z]/.test(val)) { ruleUppercase.classList.add("valid"); score++; }
        else { ruleUppercase.classList.remove("valid"); passwordIsValid = false; }

        if (/\d/.test(val)) { ruleNumber.classList.add("valid"); score++; }
        else { ruleNumber.classList.remove("valid"); passwordIsValid = false; }

        if (/[^A-Za-z0-9]/.test(val)) { ruleSpecial.classList.add("valid"); score++; }
        else { ruleSpecial.classList.remove("valid"); passwordIsValid = false; }

        // Barra
        let width = (score / 4) * 100;
        strengthFill.style.width = width + "%";

        if (score <= 1) {
            strengthFill.style.background = "red";
            strengthText.textContent = "Débil";
        } else if (score <= 3) {
            strengthFill.style.background = "orange";
            strengthText.textContent = "Buena";
        } else {
            strengthFill.style.background = "green";
            strengthText.textContent = "Fuerte";
        }
    });

    confirmInput.addEventListener('input', () => {
        if (confirmInput.value && confirmInput.value !== passInput.value) {
            matchError.style.display = 'block';
        } else {
            matchError.style.display = 'none';
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        globalError.style.display = 'none';

        if (!passwordIsValid) {
            globalError.textContent = "La contraseña no cumple los requisitos.";
            globalError.style.display = 'block';
            return;
        }
        if (passInput.value !== confirmInput.value) {
            matchError.style.display = 'block';
            return;
        }

        const btn = form.querySelector('button');
        const oldText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Actualizando...";

        try {
            const res = await fetch('http://localhost:5000/api/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, password: passInput.value })
            });
            const data = await res.json();

            if (res.ok) {
                alert("¡Contraseña actualizada correctamente!");
                window.location.href = '/login?success=verified'; // Redirige al login
            } else {
                globalError.textContent = data.error || "Error al actualizar.";
                globalError.style.display = 'block';
                btn.disabled = false;
                btn.textContent = oldText;
            }
        } catch (err) {
            console.error(err);
            globalError.textContent = "Error de conexión con el servidor.";
            globalError.style.display = 'block';
            btn.disabled = false;
            btn.textContent = oldText;
        }
    });
</script>

</body>
</html>