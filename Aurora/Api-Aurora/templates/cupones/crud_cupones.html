{% extends "base.html" %}

{% block title %}Gestión de Cupones{% endblock %}
{% block page_title %}Cupones de Descuento{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- 1. SECCIÓN DE ALERTAS -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 2. SECCIÓN DE FILTROS -->
    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('crud_cupones') }}" method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="q" class="form-label">Código del Cupón</label>
                    <input type="text" name="q" id="q" class="form-control" placeholder="Ej: VERANO2025" value="{{ filtros_activos.q if filtros_activos else '' }}">
                </div>
                <div class="col-md-4">
                    <label for="filtro_estado" class="form-label">Estado</label>
                    <select name="filtro_estado" id="filtro_estado" class="form-select">
                        <option value="">Todos</option>
                        <option value="activo" {{ 'selected' if filtros_activos and 'activo' == filtros_activos.estado }}>Activos</option>
                        <option value="pausado" {{ 'selected' if filtros_activos and 'pausado' == filtros_activos.estado }}>Pausados</option>
                        <option value="finalizado" {{ 'selected' if filtros_activos and 'finalizada' == filtros_activos.estado }}>Finalizados/Agotados</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                    <a href="{{ url_for('crud_cupones') }}" class="btn btn-warning">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. FORMULARIO PARA CREAR NUEVO CUPÓN (DISEÑO OFERTAS) -->
    <h2>Agregar Nuevo Cupón</h2>
    <div class="mb-5 p-4 rounded" style="background-color: #ffe6cc; border: 1px solid #e0d8c3;">
        <form action="{{ url_for('add_cupon') }}" method="POST" id="form-cupon" class="row g-3" autocomplete="off">
            
            <!-- Fila 1: Identificación -->
            <div class="col-md-6">
                <label class="form-label">Código del Cupón <span class="text-danger">*</span></label>
                <input type="text" name="codigo_cupon" class="form-control" minlength="6" maxlength="12" placeholder="Ej: INVIERNO25" required style="text-transform: none; font-weight: bold;">
                <div class="form-text">Entre 6 y 12 caracteres. Distingue mayúsculas/minúsculas.</div>
            </div>
            
            <div class="col-md-6">
                <label class="form-label">Nombre del Cupón (Título) <span class="text-danger">*</span></label>
                <input type="text" name="nombre_cupon" class="form-control" placeholder="Ej: Descuento especial CyberDay" required>
            </div>

            <!-- Fila 2: Configuración del Descuento -->
            <div class="col-md-6">
                <label class="form-label">Tipo de Descuento</label>
                <div class="bg-white p-2 border rounded d-flex gap-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipo_descuento" id="tipo_pct" value="pct" checked onchange="toggleDiscountType('pct')">
                        <label class="form-check-label" for="tipo_pct">Porcentaje (%)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="tipo_descuento" id="tipo_fijo" value="fijo" onchange="toggleDiscountType('fijo')">
                        <label class="form-check-label" for="tipo_fijo">Monto Fijo ($CLP)</label>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label" id="lbl-valor">Valor del Descuento (%) <span class="text-danger">*</span></label>
                <input type="number" name="descuento_valor" class="form-control" step="0.01" min="1" required placeholder="Ej: 15">
            </div>

            <!-- Fila 3: Restricciones -->
            <div class="col-md-6">
                <label class="form-label">Mínimo de Compra ($)</label>
                <input type="number" name="min_compra" class="form-control" value="0" min="0">
                <div class="form-text">Dejar en 0 para que no tenga mínimo.</div>
            </div>

            <div class="col-md-6">
                <label class="form-label">Límite de Usos (Total) <span class="text-danger">*</span></label>
                <input type="number" name="usos_max" class="form-control" value="100" min="1" required>
                <div class="form-text">Cantidad de veces que el cupón puede ser canjeado.</div>
            </div>

            <!-- Fila 4: Fechas -->
            <div class="col-md-6">
                <label class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                <input type="date" name="fecha_inicio" class="form-control" required>
            </div>

            <div class="col-md-6">
                <label class="form-label">Fecha Término <span class="text-danger">*</span></label>
                <input type="date" name="fecha_fin" class="form-control" required>
            </div>

            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-success w-100 py-2 fw-bold">Agregar Cupón</button>
            </div>
        </form>
    </div>

    <hr class="my-4">

    <!-- 4. LISTADO DE CUPONES -->
    <h2 class="mb-3">Listado de Cupones Activos</h2>
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle text-center mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Descuento</th>
                            <th>Uso</th>
                            <th>Vigencia</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if cupones %}
                            {% for c in cupones %}
                            <tr>
                                <td>{{ c.id_cupon }}</td>
                                <td><span class="fw-bold">{{ c.codigo_cupon }}</span></td>
                                <td class="text-start">{{ c.nombre_cupon or '-' }}</td>
                                <td>
                                    {% if c.descuento_pct_cupon %}
                                        <span class="text-primary fw-bold">{{ c.descuento_pct_cupon | int }}%</span>
                                    {% else %}
                                        <span class="text-success fw-bold">${{ "{:,.0f}".format(c.valor_fijo).replace(',', '.') }}</span>
                                    {% endif %}
                                    {% if c.min_compra > 0 %}
                                        <br><small class="text-muted">Min: ${{ "{:,.0f}".format(c.min_compra).replace(',', '.') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ c.usos_hechos }}</strong> / {{ c.usos_max }}
                                    <div class="progress mt-1" style="height: 5px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ (c.usos_hechos / c.usos_max * 100)|int }}%;"></div>
                                    </div>
                                </td>
                                <td class="small">
                                    {{ c.fecha_inicio }} <br>a<br> {{ c.fecha_fin }}
                                </td>
                                <td>
                                    {% if c.es_activo %}
                                        <span class="badge bg-success">ACTIVO</span>
                                    {% else %}
                                        {% if not c.vigente_bool %}
                                            <span class="badge bg-warning text-dark">PAUSADO</span>
                                        {% elif c.usos_hechos >= c.usos_max %}
                                            <span class="badge bg-danger">AGOTADO</span>
                                        {% elif c.fecha_fin < now.strftime('%Y-%m-%d') %}
                                            <span class="badge bg-secondary">VENCIDO</span>
                                        {% else %}
                                            <span class="badge bg-secondary">INACTIVO</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <!-- Botón Pausar/Reactivar -->
                                        <form action="{{ url_for('toggle_cupon', id_cupon=c.id_cupon) }}" method="POST" style="display:inline;">
                                            <button type="submit" class="btn btn-warning" title="{{ 'Pausar' if c.vigente_bool else 'Reactivar' }}">
                                                {{ 'Pausar' if c.vigente_bool else 'Activar' }}
                                            </button>
                                        </form>
                                        <!-- Botón Borrar -->
                                        <form action="{{ url_for('delete_cupon', id_cupon=c.id_cupon) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Estás seguro de eliminar el cupón {{ c.codigo_cupon }} permanentemente?');">
                                            <button type="submit" class="btn btn-danger" title="Eliminar">Borrar</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-4 text-muted">
                                    No se encontraron cupones registrados.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Scripts -->
<script>
    function toggleDiscountType(type) {
        const lbl = document.getElementById('lbl-valor');
        const input = document.getElementsByName('descuento_valor')[0];
        
        if (type === 'pct') {
            lbl.textContent = 'Valor del Descuento (%)';
            input.placeholder = 'Ej: 15';
            input.max = 100; 
        } else {
            lbl.textContent = 'Monto Fijo a Descontar ($)';
            input.placeholder = 'Ej: 5000';
            input.removeAttribute('max');
        }
    }
    
    // Inicializar fechas por defecto
    window.addEventListener('DOMContentLoaded', () => {
        const fechaInicio = document.getElementsByName('fecha_inicio')[0];
        const fechaFin = document.getElementsByName('fecha_fin')[0];
        
        if (!fechaInicio.value) {
            const hoy = new Date();
            fechaInicio.value = hoy.toISOString().split('T')[0];
            
            const enUnMes = new Date();
            enUnMes.setDate(hoy.getDate() + 30);
            fechaFin.value = enUnMes.toISOString().split('T')[0];
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}