{% extends "base.html" %}

{% block title %}Gestión de Cupones{% endblock %}
{% block page_title %}Cupones de Descuento{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- 1. ALERTAS -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 2. FILTROS -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-light border-bottom-0">
            <h5 class="mb-0 text-muted"><i class="fa-solid fa-filter"></i> Filtrar Cupones</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('crud_cupones') }}" method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="q" class="form-label fw-bold">Código</label>
                    <input type="text" name="q" id="q" class="form-control" placeholder="Ej: VERANO" value="{{ filtros_activos.q if filtros_activos else '' }}">
                </div>
                <div class="col-md-4">
                    <label for="filtro_estado" class="form-label fw-bold">Estado</label>
                    <select name="filtro_estado" id="filtro_estado" class="form-select">
                        <option value="">-- Todos --</option>
                        <option value="activo" {{ 'selected' if filtros_activos and 'activo' == filtros_activos.estado }}>Activos</option>
                        <option value="pausado" {{ 'selected' if filtros_activos and 'pausado' == filtros_activos.estado }}>Pausados</option>
                        <option value="finalizado" {{ 'selected' if filtros_activos and 'finalizada' == filtros_activos.estado }}>Finalizados</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex gap-2 justify-content-end">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                    <a href="{{ url_for('crud_cupones') }}" class="btn btn-warning">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. FORMULARIO CREAR (DISEÑO PIEL/DURAZNO IGUAL A OFERTAS) -->
    <h3 class="mb-3">Agregar Nuevo Cupón</h3>
    <div class="p-4 rounded mb-5 shadow-sm" style="background-color: #ffe6cc; border: 1px solid #e0ccb0;">
        <form action="{{ url_for('add_cupon') }}" method="POST" id="form-cupon" class="row g-3" autocomplete="off">
            
            <!-- Identificación -->
            <div class="col-md-4">
                <label class="form-label fw-bold">Código del Cupón <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fa-solid fa-barcode text-muted"></i></span>
                    <input type="text" name="codigo_cupon" class="form-control fw-bold" minlength="6" maxlength="12" placeholder="Ej: INVIERNO25" required style="letter-spacing: 1px;">
                </div>
                <div class="form-text">6-12 caracteres. Distingue mayúsculas.</div>
            </div>
            
            <div class="col-md-4">
                <label class="form-label fw-bold">Nombre (Título) <span class="text-danger">*</span></label>
                <input type="text" name="nombre_cupon" class="form-control" placeholder="Ej: Promo CyberDay" required>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Descripción</label>
                <input type="text" name="descripcion" class="form-control" maxlength="200" placeholder="Ej: Solo compras > $20k">
            </div>

            <div class="col-12"><hr class="my-2" style="opacity: 0.1;"></div>

            <!-- Descuento -->
            <div class="col-md-6">
                <label class="form-label fw-bold">Tipo de Descuento</label>
                <div class="p-2 border rounded bg-white d-flex gap-4 align-items-center">
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="radio" name="tipo_descuento" value="pct" checked onchange="toggleDiscountType(this, 'pct')">
                        <label class="form-check-label">Porcentaje (%)</label>
                    </div>
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="radio" name="tipo_descuento" value="fijo" onchange="toggleDiscountType(this, 'fijo')">
                        <label class="form-check-label">Monto Fijo ($CLP)</label>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold lbl-valor">Valor del Descuento (%) <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text bg-white addon-valor">%</span>
                    <input type="number" name="descuento_valor" class="form-control" step="0.01" min="1" required placeholder="Ej: 15">
                </div>
            </div>

            <!-- Restricciones -->
            <div class="col-md-6">
                <label class="form-label fw-bold">Mínimo de Compra ($)</label>
                <input type="number" name="min_compra" class="form-control" value="0" min="0">
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold">Límite de Usos (Total) <span class="text-danger">*</span></label>
                <input type="number" name="usos_max" class="form-control" value="100" min="1" required>
            </div>

            <!-- Fechas -->
            <div class="col-md-6">
                <label class="form-label fw-bold">Fecha Inicio <span class="text-danger">*</span></label>
                <input type="date" name="fecha_inicio" class="form-control" required>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold">Fecha Término <span class="text-danger">*</span></label>
                <input type="date" name="fecha_fin" class="form-control" required>
            </div>

            <!-- BOTÓN AGREGAR (ESTILO IGUAL A OFERTA) -->
            <div class="col-12 mt-4">
                <button type="submit" class="btn btn-success w-100" style="background-color: #198754; border-color: #198754; padding: 10px; font-weight: 500;">
                    Agregar Cupón
                </button>
            </div>
        </form>
    </div>

    <hr class="my-5">

    <!-- 4. LISTADO DE CUPONES -->
    <h3 class="mb-3 border-bottom pb-2">Listado de Cupones Activos</h3>
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0 text-center table-bordered">
                    <thead class="table-dark text-uppercase small">
                        <tr>
                            <th>ID</th>
                            <th style="width: 10%;">Código</th>
                            <th class="text-start">Nombre</th>
                            <th class="text-start" style="width: 20%;">Descripción</th>
                            <th>Descuento</th>
                            <th>Uso</th>
                            <th>Vigencia</th>
                            <th>Estado</th>
                            <th style="width: 150px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if cupones %}
                            {% for c in cupones %}
                            <tr class="{{ 'table-secondary' if not c.es_activo else '' }}">
                                <td class="text-muted fw-bold">#{{ c.id_cupon }}</td>
                                
                                <td>
                                    <span class="badge bg-light text-dark border border-secondary fs-6 font-monospace">
                                        {{ c.codigo_cupon }}
                                    </span>
                                </td>
                                
                                <!-- Nombre -->
                                <td class="text-start fw-bold">
                                    {{ c.nombre_cupon or 'Sin título' }}
                                </td>

                                <!-- Descripción -->
                                <td class="text-start">
                                    <small class="text-muted">
                                        {{ c.descripcion or '-' }}
                                    </small>
                                </td>
                                
                                <td>
                                    {% if c.descuento_pct_cupon %}
                                        <span class="text-primary fw-bold fs-5">{{ c.descuento_pct_cupon | int }}%</span>
                                        <div class="small text-muted">OFF</div>
                                    {% else %}
                                        <span class="text-success fw-bold fs-5">${{ "{:,.0f}".format(c.valor_fijo).replace(',', '.') }}</span>
                                        <div class="small text-muted">OFF</div>
                                    {% endif %}
                                    {% if c.min_compra > 0 %}
                                        <div class="badge bg-light text-secondary border mt-1">Min: ${{ "{:,.0f}".format(c.min_compra).replace(',', '.') }}</div>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="d-flex justify-content-between small mb-1 fw-bold">
                                        <span>{{ c.usos_hechos }}</span>
                                        <span class="text-muted">/ {{ c.usos_max }}</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {{ 'bg-danger' if c.usos_hechos >= c.usos_max else 'bg-info' }}" 
                                             role="progressbar" 
                                             style="width: {{ (c.usos_hechos / c.usos_max * 100)|int }}%;">
                                        </div>
                                    </div>
                                </td>
                                
                                <td class="small text-nowrap">
                                    {{ c.fecha_inicio }} <br> {{ c.fecha_fin }}
                                </td>
                                
                                <td>
                                    {% if c.es_activo %}
                                        <span class="badge bg-success">ACTIVO</span>
                                    {% else %}
                                        {% if not c.vigente_bool %}
                                            <span class="badge bg-warning text-dark">PAUSADO</span>
                                        {% elif c.usos_hechos >= c.usos_max %}
                                            <span class="badge bg-danger">AGOTADO</span>
                                        {% elif c.fecha_fin < now.strftime('%Y-%m-%d') %}
                                            <span class="badge bg-secondary">VENCIDO</span>
                                        {% else %}
                                            <span class="badge bg-secondary">INACTIVO</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                
                                <!-- COLUMNA ACCIONES (BOTONES CON TEXTO) -->
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <!-- Botón Editar -->
                                        <button type="button" class="btn btn-sm btn-primary w-100" data-bs-toggle="modal" data-bs-target="#editCuponModal{{ c.id_cupon }}">
                                            Editar
                                        </button>

                                        <!-- Botón Pausar -->
                                        <form action="{{ url_for('toggle_cupon', id_cupon=c.id_cupon) }}" method="POST">
                                            <button type="submit" class="btn btn-sm btn-warning w-100">
                                                {{ 'Pausar' if c.vigente_bool else 'Activar' }}
                                            </button>
                                        </form>
                                        
                                        <!-- Botón Eliminar -->
                                        <form action="{{ url_for('delete_cupon', id_cupon=c.id_cupon) }}" method="POST" onsubmit="return confirm('¿Estás seguro de eliminar el cupón {{ c.codigo_cupon }} permanentemente?');">
                                            <button type="submit" class="btn btn-sm btn-danger w-100">
                                                Eliminar
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>

                            <!-- MODAL EDITAR (DENTRO DEL BUCLE) -->
                            <div class="modal fade" id="editCuponModal{{ c.id_cupon }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header bg-primary text-white">
                                            <h5 class="modal-title">Editar Cupón #{{ c.id_cupon }}</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body text-start">
                                            <form action="{{ url_for('edit_cupon', id_cupon=c.id_cupon) }}" method="POST">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">Código</label>
                                                        <input type="text" name="codigo_cupon" class="form-control" value="{{ c.codigo_cupon }}" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">Nombre</label>
                                                        <input type="text" name="nombre_cupon" class="form-control" value="{{ c.nombre_cupon }}" required>
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label">Descripción</label>
                                                        <textarea name="descripcion" class="form-control" rows="2">{{ c.descripcion or '' }}</textarea>
                                                    </div>
                                                    
                                                    <div class="col-12"><hr></div>

                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">Tipo Descuento</label>
                                                        <div class="border rounded p-2 d-flex gap-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="tipo_descuento" value="pct" 
                                                                       {{ 'checked' if c.descuento_pct_cupon else '' }} 
                                                                       onchange="toggleDiscountType(this, 'pct')">
                                                                <label class="form-check-label">Porcentaje</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="tipo_descuento" value="fijo" 
                                                                       {{ 'checked' if c.valor_fijo else '' }} 
                                                                       onchange="toggleDiscountType(this, 'fijo')">
                                                                <label class="form-check-label">Fijo</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold lbl-valor">Valor ({{ '%' if c.descuento_pct_cupon else '$' }})</label>
                                                        <div class="input-group">
                                                            <span class="input-group-text addon-valor">{{ '%' if c.descuento_pct_cupon else '$' }}</span>
                                                            <input type="number" name="descuento_valor" class="form-control" step="0.01" required 
                                                                   value="{{ c.descuento_pct_cupon if c.descuento_pct_cupon else c.valor_fijo }}">
                                                        </div>
                                                    </div>

                                                    <div class="col-md-6">
                                                        <label class="form-label">Mínimo Compra</label>
                                                        <input type="number" name="min_compra" class="form-control" value="{{ c.min_compra }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Usos Max</label>
                                                        <input type="number" name="usos_max" class="form-control" value="{{ c.usos_max }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Inicio</label>
                                                        <input type="date" name="fecha_inicio" class="form-control" value="{{ c.fecha_inicio }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Fin</label>
                                                        <input type="date" name="fecha_fin" class="form-control" value="{{ c.fecha_fin }}">
                                                    </div>
                                                </div>
                                                <div class="modal-footer mt-4 pb-0 px-0">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- FIN MODAL -->

                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="text-center py-4 text-muted">
                                    No hay cupones registrados.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    function toggleDiscountType(radio, type) {
        const form = radio.closest('form');
        const lbl = form.querySelector('.lbl-valor');
        const input = form.querySelector('input[name="descuento_valor"]');
        const addon = form.querySelector('.addon-valor');
        
        if (type === 'pct') {
            lbl.textContent = 'Valor del Descuento (%)';
            addon.textContent = '%';
            input.placeholder = 'Ej: 15';
            input.max = 100; 
        } else {
            lbl.textContent = 'Monto Fijo a Descontar ($)';
            addon.textContent = '$';
            input.placeholder = 'Ej: 5000';
            input.removeAttribute('max');
        }
    }
    
    window.addEventListener('DOMContentLoaded', () => {
        const addForm = document.getElementById('form-cupon');
        if(addForm) {
            const fechaInicio = addForm.querySelector('input[name="fecha_inicio"]');
            const fechaFin = addForm.querySelector('input[name="fecha_fin"]');
            
            if (!fechaInicio.value) {
                const hoy = new Date();
                fechaInicio.value = hoy.toISOString().split('T')[0];
                
                const enUnMes = new Date();
                enUnMes.setDate(hoy.getDate() + 30);
                fechaFin.value = enUnMes.toISOString().split('T')[0];
            }
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}