<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRUD Productos y Stock</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h1 class="mb-4">Productos y Stock</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                {{ message }}<br>
            {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Tabla de Productos -->
    <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>SKU</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Descripción</th>
                <th>Categoría</th>
                <th>Imagen</th>
                <th>Stock</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for p in productos %}
            <tr>
                <td>{{ p.id_producto }}</td>
                <td>{{ p.sku }}</td>
                <td>{{ p.nombre_producto }}</td>
                <td>${{ "%.2f"|format(p.precio_producto) }}</td>
                <td>{{ p.descripcion_producto or "-" }}</td>
                <td>{{ p.categoria_producto or "-" }}</td>
                <td>
                    {% if p.imagen_url %}
                        <img src="{{ p.imagen_url }}" alt="Imagen producto" style="width:60px; height:auto;">
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ p.stock if p.stock else 0 }}</td>
                <td>
                    <!-- Botón Editar -->
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editProductoModal{{p.id_producto}}">Editar Producto</button>
                    
                    <!-- Botón Eliminar -->
                    <form action="{{ url_for('delete_producto', id=p.id_producto) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                    </form>

                    <!-- Botón Editar Stock -->
                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#stockModal{{p.id_producto}}">Editar Stock</button>
                </td>
            </tr>

            <!-- Modal Editar Producto -->
            <div class="modal fade" id="editProductoModal{{p.id_producto}}" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form action="{{ url_for('edit_producto', id=p.id_producto) }}" method="post">
                    <div class="modal-header">
                      <h5 class="modal-title">Editar Producto</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <input type="text" class="form-control mb-2" name="sku" value="{{ p.sku }}" required>
                      <input type="text" class="form-control mb-2" name="nombre" value="{{ p.nombre_producto }}" required>
                      <input type="number" step="0.01" class="form-control mb-2" name="precio" value="{{ p.precio_producto }}" required>
                      <textarea class="form-control mb-2" name="descripcion" placeholder="Descripción">{{ p.descripcion_producto }}</textarea>
                      <input type="text" class="form-control mb-2" name="categoria" value="{{ p.categoria_producto }}">
                      <input type="text" class="form-control mb-2" name="imagen_url" value="{{ p.imagen_url }}" placeholder="URL de la imagen">
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Modal Editar Stock -->
            <div class="modal fade" id="stockModal{{p.id_producto}}" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form action="{{ url_for('edit_stock', id=p.id_producto) }}" method="post">
                    <div class="modal-header">
                      <h5 class="modal-title">Editar Stock</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <label for="sucursal">Sucursal</label>
                      <select name="id_sucursal" class="form-control mb-2" required>
                        {% for s in sucursales %}
                          <option value="{{ s.id_sucursal }}">{{ s.nombre_sucursal }}</option>
                        {% endfor %}
                      </select>
                      <input type="number" class="form-control mb-2" name="stock" placeholder="Nuevo stock" required>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-warning">Guardar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            {% endfor %}
        </tbody>
    </table>

    <!-- Formulario Agregar Producto -->
    <h2 class="mt-5">Agregar Producto</h2>
<form action="{{ url_for('add_producto') }}" method="post" class="row g-3">
    <div class="col-md-3">
        <input type="text" class="form-control" name="sku" placeholder="SKU" required>
    </div>
    <div class="col-md-3">
        <input type="text" class="form-control" name="nombre" placeholder="Nombre producto" required>
    </div>
    <div class="col-md-2">
        <input type="number" step="0.01" class="form-control" name="precio" placeholder="Precio" required>
    </div>
    <div class="col-md-4">
        <label for="categoria_producto" class="form-label visually-hidden">Categoría:</label>
        <select name="categoria" id="categoria_producto" class="form-select" required>
            <option value="">Selecciona una categoría</option>
            <option value="Abrigos">Abrigos</option>
            <option value="Accesorios">Accesorios</option>
            <option value="Calzado">Calzado</option>
            <option value="Chaquetas">Chaquetas</option>
            <option value="Joyas">Joyas</option>
            <option value="Pantalones">Pantalones</option>
            <option value="Parkas">Parkas</option>
            <option value="Polerones">Polerones</option>
            <option value="Poleras">Poleras</option>
            <option value="Ropa interior">Ropa interior</option>
            <option value="Top">Top</option>
            <option value="Traje de baño">Traje de baño</option>
        </select>
    </div>

    <div class="col-md-12">
        <textarea class="form-control" name="descripcion" placeholder="Descripción del producto"></textarea>
    </div>
    <div class="col-md-12">
        <input type="text" class="form-control" name="imagen_url" placeholder="URL de la imagen">
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-success w-100">Agregar</button>
    </div>
</form>

    <!-- Tabla de Sucursales -->
    <h2 class="mt-5">Sucursales</h2>
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Región</th>
                <th>Comuna</th>
                <th>Dirección</th>
                <th>Latitud</th>
                <th>Longitud</th>
                <th>Horario</th>
                <th>Teléfono</th>
            </tr>
        </thead>
        <tbody>
            {% for s in sucursales %}
            <tr>
                <td>{{ s.id_sucursal }}</td>
                <td>{{ s.nombre_sucursal }}</td>
                <td>{{ s.region_sucursal }}</td>
                <td>{{ s.comuna_sucursal }}</td>
                <td>{{ s.direccion_sucursal }}</td>
                <td>{{ s.latitud_sucursal }}</td>
                <td>{{ s.longitud_sucursal }}</td>
                <td>{{ s.horario_json }}</td>
                <td>{{ s.telefono_sucursal }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Formulario Agregar Sucursal -->
    <div class="card mt-5 mb-5">
      <div class="card-header">
        <h2>Agregar Sucursal</h2>
      </div>
      <div class="card-body">
        <form action="{{ url_for('add_sucursal') }}" method="post" class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" name="nombre" placeholder="Nombre sucursal" required>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" name="region" placeholder="Región" required>
          </div>
          <div class="col-md-4">
            <input type="text" class="form-control" name="comuna" placeholder="Comuna" required>
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="direccion" placeholder="Dirección" required>
          </div>
          <div class="col-md-3">
            <input type="number" step="0.000001" class="form-control" name="latitud" placeholder="Latitud (-90 a 90)">
          </div>
          <div class="col-md-3">
            <input type="number" step="0.000001" class="form-control" name="longitud" placeholder="Longitud (-180 a 180)">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="horario" placeholder='Horario JSON, ej: {"lunes":"9-18"}'>
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="telefono" placeholder="Teléfono">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-success w-100">Agregar Sucursal</button>
          </div>
        </form>
      </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
