<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aurora | Login</title>
  <link rel="stylesheet" href="/Public/Css/login.css">
  <style>
    .password-rules { font-size: 0.85em; margin-top: 5px; }
    .rule { color: red; }
    .rule.valid { color: green; }
    .strength-bar { height: 8px; width: 100%; background: #ddd; border-radius: 4px; margin-top: 5px; }
    .strength-fill { height: 100%; width: 0; border-radius: 4px; transition: width 0.3s; }
    .strength-text { font-size: 0.85em; margin-top: 3px; }
    /* Estilo para el mensaje de error del servidor */
    .server-error { 
        padding: 10px; 
        background-color: #fce4e4; 
        border: 1px solid #fcc; 
        color: #d32f2f; 
        border-radius: 4px; 
        margin-bottom: 10px;
        font-size: 0.9em;
        text-align: center;
    }
  </style>
</head>
<body>
  <div class="box">
    
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('login', this)">Login</button>
      <button class="tab-btn" onclick="openTab('register', this)">Registro</button>
    </div>

    <!-- Formulario de Login -->
    <form id="login" class="active" method="POST" action="http://localhost:5000/login">
      <input type="email" name="email_usuario" placeholder="Correo" required>
      <input type="password" name="password" placeholder="Contraseña" required>
      <button type="submit">Entrar</button>
    </form>

    <!-- Formulario de Registro -->
    <form id="register" method="POST" action="http://localhost:5000/register">
      <!-- Mensaje de error de registro (se muestra si viene de Flask) -->
      <div id="register-server-error-container"></div>
      
      <input type="text" name="nombre_usuario" placeholder="Nombre" required>
      <input type="text" name="apellido_paterno" placeholder="Apellido Paterno" required>
      <input type="text" name="apellido_materno" placeholder="Apellido Materno" required>
      
      <!-- Correo Electrónico Principal -->
      <input type="email" name="email_usuario" id="register-email" placeholder="Correo Electrónico" required>
      <div id="email-exists-error" class="error-msg" style="color:red; font-size:0.85em; display:none; min-height: 20px;">
        ⚠️ Este correo ya está en uso.
      </div>
      <input type="email" name="email_confirm" placeholder="Confirmar Correo Electrónico" required>
      <input type="text" name="calle" placeholder="Calle">
      <input type="text" name="numero_calle" placeholder="Número de Calle">


      <!-- Región -->
      <select id="region" name="region" required>
      <option value="">Selecciona Región</option>
    
        <option value="Arica y Parinacota">Arica y Parinacota</option>
        <option value="Tarapacá">Tarapacá</option>
        <option value="Antofagasta">Antofagasta</option>
        <option value="Atacama">Atacama</option>
        <option value="Coquimbo">Coquimbo</option>
        <option value="Valparaíso">Valparaíso</option>
        <option value="Metropolitana">Metropolitana</option>
        <option value="O'Higgins">O'Higgins</option>
        <option value="Maule">Maule</option>
        <option value="Ñuble">Ñuble</option>
        <option value="Biobío">Biobío</option>
        <option value="La Araucanía">La Araucanía</option>
        <option value="Los Ríos">Los Ríos</option>
        <option value="Los Lagos">Los Lagos</option>
        <option value="Aysén">Aysén</option>
        <option value="Magallanes y Antártica Chilena">Magallanes y Antártica Chilena</option>
    
      </select>

      <!-- Ciudad -->
      <select id="ciudad" name="ciudad" required>
        <option value="">Selecciona Ciudad</option>
      </select>

      <!-- Comuna -->
      <select id="comuna" name="comuna" required>
        <option value="">Selecciona Comuna</option>
      </select>

      <input type="text" name="telefono" id="register-telefono" placeholder="Número Telefónico" required>
      <div id="telefono-exists-error" class="error-msg" style="color:red; font-size:0.85em; display:none; min-height: 20px;">
        ⚠️ Este número telefónico ya está en uso.
      </div>

      <!-- Contraseña -->
      <input type="password" id="password" name="password" placeholder="Contraseña" required>
      <div class="password-rules">
        <div id="rule-length" class="rule">6–24 caracteres</div>
        <div id="rule-uppercase" class="rule">Al menos una mayúscula</div>
        <div id="rule-number" class="rule">Al menos un número</div>
        <div id="rule-special" class="rule">Al menos un carácter especial</div>
      </div>
      <div class="strength-bar"><div id="strength-fill" class="strength-fill"></div></div>
      <div id="strength-text" class="strength-text">Débil</div>

      <input type="password" id="password_confirm" name="password_confirm" placeholder="Confirmar Contraseña" required>
      <div id="password-error" style="color: red; font-size: 0.85em; margin-top: 5px; min-height: 20px;"></div>

      <button type="submit" name="registrar">Terminar Registro de Cuenta</button>
    </form>

    <div class="back">
      <a href="../src/main.html">← Volver</a>
    </div>
  </div>


<script>
// ==========================
// UTILIDADES GENERALES
// ==========================
function openTab(tabId, clickedBtn) {
  document.querySelectorAll("form").forEach(f => f.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(tabId)?.classList.add("active");
  clickedBtn?.classList.add("active");
}

// ==========================
// VALIDACIÓN CONTRASEÑA
// ==========================
const passwordInput = document.getElementById("password");
const ruleLength = document.getElementById("rule-length");
const ruleUppercase = document.getElementById("rule-uppercase");
const ruleNumber = document.getElementById("rule-number");
const ruleSpecial = document.getElementById("rule-special");
const strengthFill = document.getElementById("strength-fill");
const strengthText = document.getElementById("strength-text");
const passInput = document.getElementById("password");
const passConfirm = document.getElementById("password_confirm");
const passError = document.getElementById("password-error");
const registerForm = document.getElementById("register"); // Usamos este para todos los listeners

// FUNCIÓN: Validar coincidencia de contraseñas
function validatePasswords() {
  if (passInput.value && passConfirm.value && passInput.value !== passConfirm.value) {
    passError.textContent = "⚠️ Las contraseñas no coinciden.";
    passConfirm.style.border = "2px solid red";
    passInput.dataset.invalid = "true";
  } else {
    passError.textContent = "";
    passConfirm.style.border = "";
    delete passInput.dataset.invalid;
  }
}

passInput.addEventListener("input", validatePasswords);
passConfirm.addEventListener("input", validatePasswords);

// FUNCIÓN: Validar requisitos de contraseña en tiempo real
passwordInput.addEventListener("input", () => {
  const val = passwordInput.value;
  let score = 0;

  // Validaciones visuales
  if (val.length >= 6 && val.length <= 24) { ruleLength.classList.add("valid"); score++; }
  else { ruleLength.classList.remove("valid"); }

  if (/[A-Z]/.test(val)) { ruleUppercase.classList.add("valid"); score++; }
  else { ruleUppercase.classList.remove("valid"); }

  if (/\d/.test(val)) { ruleNumber.classList.add("valid"); score++; }
  else { ruleNumber.classList.remove("valid"); }

  if (/[^A-Za-z0-9]/.test(val)) { ruleSpecial.classList.add("valid"); score++; }
  else { ruleSpecial.classList.remove("valid"); }

  // Barra de fuerza visual
  let width = (score / 4) * 100;
  strengthFill.style.width = width + "%";

  if (score <= 1) {
    strengthFill.style.background = "red";
    strengthText.textContent = "Débil";
  } else if (score === 2 || score === 3) {
    strengthFill.style.background = "orange";
    strengthText.textContent = "Buena";
  } else if (score === 4) {
    strengthFill.style.background = "green";
    strengthText.textContent = "Fuerte";
  }
});

// ==========================
// REGIÓN - CIUDAD - COMUNA
// ==========================
const ciudadesPorRegion = {
  // ... (Tu objeto ciudadesPorRegion se mantiene igual)
  "Arica y Parinacota": {
    "Arica": ["Arica Centro", "Azapa", "Chacalluta"],
    "Putre": ["Putre Centro", "Quebrada de Acha", "Belén"],
    "Camarones": ["Codpa", "Cuya", "Caleta Vítor"]
  },
  "Tarapacá": {
    "Iquique": ["Alto Hospicio", "Iquique Centro", "Playa Brava"],
    "Pozo Almonte": ["Pozo Almonte Urbano", "La Tirana", "Pampa del Tamarugal"],
    "Pica": ["Matilla", "Llanos de Pica", "Valle de Quisma"]
  },
  "Antofagasta": {
    "Antofagasta": ["Antofagasta Centro", "Sector Norte", "La Chimba"],
    "Calama": ["Calama Central", "Oasis", "Chiu Chiu"],
    "Tocopilla": ["Tocopilla Urbano", "Barriles", "María Elena"]
  },
  "Atacama": {
    "Copiapó": ["Copiapó Centro", "Tierra Amarilla", "Paipote"],
    "Vallenar": ["Vallenar Urbano", "Huasco", "Freirina"],
    "Chañaral": ["Chañaral Central", "El Salado", "Diego de Almagro"]
  },
  "Coquimbo": {
    "La Serena": ["La Serena Centro", "Las Compañías", "Coquimbo"],
    "Ovalle": ["Ovalle Central", "Samo Alto", "Monte Patria"],
    "Illapel": ["Illapel Urbano", "Los Vilos", "Salamanca"]
  },
  "Valparaíso": {
    "Valparaíso": ["Playa Ancha", "Cerro Alegre", "Almendral"],
    "Viña del Mar": ["Reñaca", "Centro", "Miraflores"],
    "San Antonio": ["San Antonio Centro", "Cartagena", "Algarrobo"],
  },
  "Metropolitana": { 
    "Santiago": ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba",
    "Independencia", "La Cisterna","La Florida","La Granja","La Pintana", "La Reina","Las Condes", "Lo Barnechea", "Lo Espejo",
    "Lo Prado","Macul", "Maipú","Ñuñoa", "Pedro Aguirre Cerda","Peñalolén","Providencia","Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca",
    "San Joaquín", "San Miguel", "San Ramón", "Santiago", "Vitacura"],
    "Cordillera": ["Puente Alto", "San José de Maipo", "Pirque"]
  },
  "O'Higgins": {
    "Rancagua": ["Rancagua Centro", "Machalí", "Graneros"],
    "San Fernando": ["San Fernando Urbano", "Chimbarongo", "Peralillo"],
    "Rengo": ["Rengo Centro", "Requínoa", "Malloa"]
  },
  "Maule": {
    "Talca": ["Talca Centro", "Maule", "San Clemente"],
    "Curicó": ["Curicó Urbano", "Molina", "Romeral"],
    "Linares": ["Linares Central", "Parral", "San Javier"]
  },
  "Ñuble": {
    "Chillán": ["Chillán Viejo", "San Carlos", "Quillón"],
    "Bulnes": ["Bulnes Urbano", "San Ignacio", "El Carmen"],
    "Yungay": ["Yungay Centro", "Pemuco", "Cabrero"]
  },
  "Biobío": {
    "Concepción": ["Talcahuano", "San Pedro de la Paz", "Chiguayante"],
    "Los Ángeles": ["Los Ángeles Centro", "Mulchén", "Nacimiento"],
    "Arauco": ["Lebu", "Cañete", "Curanipe"]
  },
  "La Araucanía": {
    "Temuco": ["Padre Las Casas", "Villarrica", "Pucón"],
    "Angol": ["Angol Urbano", "Renaico", "Collipulli"],
    "Lautaro": ["Lautaro Central", "Carahue", "Nueva Imperial"]
  },
  "Los Ríos": {
    "Valdivia": ["Valdivia Centro", "Lanco", "Panguipulli"],
    "La Unión": ["Río Bueno", "Futrono", "Lago Ranco"],
    "Mariquina": ["San José de la Mariquina", "Máfil", "Corral"]
  },
  "Los Lagos": {
    "Puerto Montt": ["Puerto Varas", "Frutillar", "Llanquihue"],
    "Osorno": ["Osorno Urbano", "Río Negro", "Purranque"],
    "Castro": ["Ancud", "Chonchi", "Quellón"]
  },
  "Aysén": {
    "Coyhaique": ["Coyhaique Centro", "Puerto Aysén", "Puerto Cisnes"],
    "Chile Chico": ["Chile Chico Urbano", "Cochrane", "Villa O'Higgins"],
    "Melinka": ["Puerto Aguirre", "Puerto Chacabuco", "Lago Verde"]
  },
  "Magallanes y Antártica Chilena": {
    "Punta Arenas": ["Punta Arenas Central", "Puerto Natales", "Porvenir"],
    "Puerto Williams": ["Puerto Williams Centro", "Cabo de Hornos", "Timaukel"],
    "Primavera": ["Cerro Sombrero", "Pampa Guanaco", "Bahía Inútil"]
  }
};

document.getElementById("region").addEventListener("change", e => {
  const region = e.target.value;
  const ciudadSelect = document.getElementById("ciudad");
  ciudadSelect.innerHTML = "<option value=''>Selecciona Ciudad</option>";
  document.getElementById("comuna").innerHTML = "<option value=''>Selecciona Comuna</option>";

  if (ciudadesPorRegion[region]) {
    Object.keys(ciudadesPorRegion[region]).forEach(ciudad => {
      ciudadSelect.innerHTML += `<option value="${ciudad}">${ciudad}</option>`;
    });
  }
});

document.getElementById("ciudad").addEventListener("change", e => {
  const region = document.getElementById("region").value;
  const ciudad = e.target.value;
  const comunaSelect = document.getElementById("comuna");
  comunaSelect.innerHTML = "<option value=''>Selecciona Comuna</option>";

  if (ciudadesPorRegion[region] && ciudadesPorRegion[region][ciudad]) {
    ciudadesPorRegion[region][ciudad].forEach(comuna => {
      comunaSelect.innerHTML += `<option value="${comuna}">${comuna}</option>`;
    });
  }
});


// ===================================================
// LÓGICA DE VALIDACIÓN DE CORREO Y MANEJO DE ERRORES
// ===================================================

const emailInput = document.getElementById("register-email");
const emailError = document.getElementById("email-exists-error");
const registerErrorContainer = document.getElementById("register-server-error-container");

// 1. VALIDAR SI EL CORREO YA EXISTE (Asíncrono al perder el foco)
emailInput.addEventListener("blur", async () => {
  const email = emailInput.value.trim();
  if (!email) {
    emailError.style.display = "none";
    emailInput.style.border = "";
    delete emailInput.dataset.invalid;
    return;
  }
  
  // Ocultamos el mensaje de error de servidor si el usuario está interactuando
  if (registerErrorContainer.textContent.includes("correo")) {
      registerErrorContainer.innerHTML = '';
  }

  try {
    // Usamos el endpoint GET que definimos en Flask
    const res = await fetch(`http://localhost:5000/check_email?email=${encodeURIComponent(email)}`);
    const data = await res.json();

    if (data.exists) {
      emailError.style.display = "block";
      emailInput.style.border = "2px solid red";
      emailInput.dataset.invalid = "true";
    } else {
      emailError.style.display = "none";
      emailInput.style.border = "";
      delete emailInput.dataset.invalid;
    }
  } catch (err) {
    console.error("Error al verificar correo asíncrono:", err);
    // Permitir el envío si hay error de red, la validación final la hará Flask
  }
});

// 2. BLOQUEAR ENVÍO EN EL CLIENTE si la validación asíncrona falló.
registerForm.addEventListener("submit", (e) => {
  // Validar coincidencia y seguridad de contraseña (tu lógica existente)
  const password = passInput.value;
  const confirmPassword = passConfirm.value;
  const hasLength = password.length >= 6 && password.length <= 24;
  const hasUppercase = /[A-Z]/.test(password);
  const hasNumber = /\d/.test(password);
  const hasSpecial = /[^A-Za-z0-9]/.test(password);

  if (password !== confirmPassword) {
    e.preventDefault();
    passError.textContent = "⚠️ Las contraseñas no coinciden. Corrige antes de continuar.";
    passConfirm.style.border = "2px solid red";
    return;
  }

  if (!hasLength || !hasUppercase || !hasNumber || !hasSpecial) {
    e.preventDefault();
    passError.textContent = "⚠️ La contraseña no cumple con los requisitos mínimos.";
    passInput.style.border = "2px solid red";
    return;
  }
  
  // Validar correo asíncrono
  if (emailInput.dataset.invalid === "true") {
    e.preventDefault();
    // Muestra el mensaje de error y enfoca el input
    emailError.style.display = "block"; 
    emailInput.focus();
  }

  // Bloquear envío si el teléfono ya existe
if (telefonoInput.dataset.invalid === "true") {
    e.preventDefault();
    telefonoError.style.display = "block";
    telefonoInput.focus();
    return;
}


  // Si pasa todas las validaciones de cliente, se envía a Flask.
});


// 3. MOSTRAR ERRORES DEL SERVIDOR (Flask)
document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    const tab = urlParams.get('tab');
    
    let errorMessage = '';

    if (error === 'email_exists') {
        errorMessage = "⛔ El correo electrónico ingresado ya está asociado a otra cuenta. Por favor, utiliza uno diferente.";
    } else if (error === 'email_mismatch') {
        errorMessage = "⚠️ Los correos electrónicos no coinciden.";
    } else if (error === 'password_mismatch') {
        errorMessage = "⚠️ Las contraseñas no coinciden.";
    } else if (error === 'weak_password') {
        const msg = urlParams.get('msg') || "Tu contraseña no cumple con los requisitos mínimos.";
        errorMessage = `⚠️ Contraseña inválida: ${msg}`;
    }
    if (error === 'telefono_exists') {
    errorMessage = "⛔ **Error de Registro:** El número telefónico ingresado ya está asociado a otra cuenta. Por favor, utiliza otro.";
    }

    // Puedes añadir más errores aquí según los que definas en Flask

    if (errorMessage && tab === 'register') {
        // Muestra el mensaje de error en el contenedor y cambia a la pestaña de registro
        registerErrorContainer.innerHTML = `<div class="server-error">${errorMessage}</div>`;
        const registerTabBtn = document.querySelector(".tab-btn[onclick*='register']");
        openTab('register', registerTabBtn);

        // Opcional: limpiar la URL para que el mensaje no se muestre al refrescar
        history.replaceState(null, '', window.location.pathname); 
    }

    
});

const telefonoInput = document.getElementById("register-telefono");
const telefonoError = document.getElementById("telefono-exists-error");

telefonoInput.addEventListener("blur", async () => {
    const telefono = telefonoInput.value.trim();
    if (!telefono) {
        telefonoError.style.display = "none";
        telefonoInput.style.border = "";
        delete telefonoInput.dataset.invalid;
        return;
    }

    try {
        const res = await fetch(`http://localhost:5000/check_telefono?telefono=${encodeURIComponent(telefono)}`);
        const data = await res.json();

        if (data.exists) {
            telefonoError.style.display = "block";
            telefonoInput.style.border = "2px solid red";
            telefonoInput.dataset.invalid = "true";
        } else {
            telefonoError.style.display = "none";
            telefonoInput.style.border = "";
            delete telefonoInput.dataset.invalid;
        }
    } catch (err) {
        console.error("Error al verificar teléfono asíncrono:", err);
    }
});

</script>


</body>
</html>
