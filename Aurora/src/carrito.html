<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aurora | Carrito</title>
  <link rel="stylesheet" href="../Public/Css/style.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

  <style>
    /* --- ESTILOS SECCI√ìN ENV√çO --- */
    .shipping-section {
        background: #fff;
        padding: 25px;
        margin-top: 2rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .shipping-section h3 { margin-bottom: 1.5rem; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
    
    .shipping-options { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .shipping-radio { flex: 1; min-width: 250px; cursor: pointer; position: relative; }
    .shipping-radio input { position: absolute; opacity: 0; }
    .radio-box {
        display: flex; align-items: center; gap: 12px;
        padding: 15px 20px; border: 2px solid #eee; border-radius: 8px;
        font-weight: 600; color: #555; transition: all 0.2s ease;
        background: #fcfcfc;
    }
    .radio-box i { font-size: 1.2rem; color: #888; transition: color 0.2s; }
    .shipping-radio input:checked + .radio-box {
        border-color: #000; 
        background-color: #fffbf0; 
        color: #000;
    }
    .shipping-radio input:checked + .radio-box i { color: #d4a017; }

    .shipping-form { margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ddd; animation: fadeIn 0.3s; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: #444; }
    .form-control { 
        padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; 
        background-color: #fff; transition: border-color 0.2s;
    }
    .form-control:disabled { background-color: #f2f2f2; color: #999; cursor: not-allowed; }
    .form-control:focus { border-color: #000; outline: none; }
    .full-width { grid-column: 1 / -1; }

    .info-box {
        grid-column: 1 / -1; background: #e8f4fd; color: #0c5460;
        padding: 15px; border-radius: 6px; font-size: 0.95rem;
        display: flex; align-items: flex-start; gap: 12px; border-left: 4px solid #17a2b8;
    }

    .cart-summary-box {
        background: #fafafa; padding: 25px; margin-top: 30px;
        border-radius: 8px; border: 1px solid #eee;
    }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.05rem; color: #555; }
    .summary-total { 
        display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; 
        border-top: 2px solid #ddd; font-size: 1.4rem; font-weight: 800; color: #000; 
    }
    .cart-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 25px; flex-wrap: wrap; }

    /* Estilos Cup√≥n */
    .coupon-container {
        margin: 15px 0;
        padding: 15px 0;
        border-top: 1px dashed #ddd;
        border-bottom: 1px dashed #ddd;
    }
    .coupon-input-group { display: flex; gap: 10px; }
    #coupon-msg { font-size: 0.85rem; margin-top: 5px; min-height: 20px; font-weight: 500; }
    .btn-coupon {
        background-color: #333; color: white; border: none; padding: 0 15px;
        border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;
    }
    .btn-coupon:hover { background-color: #000; }
    .btn-coupon.remove { background-color: #dc3545; }
    .btn-coupon.remove:hover { background-color: #bb2d3b; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
    <header>
    <div class="container">
      <div class="header-content">
        <a href="/src/main.html" class="logo">AURORA</a>
        <ul class="nav-links">
          <li><a href="/src/colecciones.html">Colecciones</a></li>
          <li class="nav-item-with-megamenu">
            <a href="/src/productos.html">Productos</a>
            <div class="mega-menu">
              <div class="mega-menu-content container">
                <h4>Categor√≠as</h4>
                <ul class="mega-menu-list">
                  <li><a href="/src/productos.html#categoria=Abrigos">Abrigos</a></li>
                  <li><a href="/src/productos.html#categoria=Accesorios">Accesorios</a></li>
                  <li><a href="/src/productos.html#categoria=Calzado">Calzado</a></li>
                  <li><a href="/src/productos.html#categoria=Chaquetas">Chaquetas</a></li>
                  <li><a href="/src/productos.html#categoria=Joyas">Joyas</a></li>
                  <li><a href="/src/productos.html#categoria=Pantalones">Pantalones</a></li>
                  <li><a href="/src/productos.html#categoria=Parkas">Parkas</a></li>
                  <li><a href="/src/productos.html#categoria=Polerones">Polerones</a></li>
                  <li><a href="/src/productos.html#categoria=Poleras">Poleras</a></li>
                  <li><a href="/src/productos.html#categoria=Ropa interior">Ropa interior</a></li>
                  <li><a href="/src/productos.html#categoria=Top">Top</a></li>
                  <li><a href="/src/productos.html#categoria=Traje de ba√±o">Traje de ba√±o</a></li>
                </ul>
              </div>
            </div>
          </li>
          <li><a href="/src/ofertas.html">Ofertas</a></li>
        </ul>

        <div class="header-actions">
          <div class="branch-selector">
            <button id="branch-display-btn" class="branch-display-button" type="button">üìç Buscando...</button>
            <div id="branch-list-dropdown" class="branch-dropdown-menu" style="display: none;">
                <div class="dropdown-loading">Cargando sucursales...</div>
            </div>
          </div>
          <a href="./carrito.html" class="icon-btn icon-cart" aria-label="Carrito"></a>
          <a href="/src/login.html" id="login-btn" class="icon-btn icon-login" aria-label="Login"></a>
          <span id="welcome-msg" style="display:none; margin-left:10px; font-weight:bold;"></span>
          <a href="../src/perfil.html" id="perfil-menu-btn" class="icon-btn" style="display: none;" aria-label="Mi perfil">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </a>
          <button id="logout-btn" class="icon-btn icon-logout" aria-label="Logout" style="display: none; background: none; border: none; cursor: pointer; padding: 0; vertical-align: middle;">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
          </button>
          <span id="admin-menu-btn" style="display:none;">
              <a href="/src/main_menu.html" class="btn btn-sm btn-outline-light">Panel Admin</a>
          </span>
        </div>
      </div>
    </div>
 </header>

<main class="site-main">
  <div class="container">
    <h1>üõçÔ∏è Carrito de Compras</h1>

    <div class="cart-steps">
      <span class="step active">Carrito</span>
      <span class="step">Pago</span>
      <span class="step">Confirmaci√≥n</span>
    </div>
    
    <div id="cart-container"></div>

    <div id="shipping-container" class="shipping-section" style="display: none;">
        <h3><i class="fas fa-truck"></i> Opciones de Entrega</h3>
        
        <div class="shipping-options">
          <label class="shipping-radio">
            <input type="radio" name="tipo_entrega" value="retiro"> 
            <span class="radio-box">
              <span>üè™</span> Retiro en Tienda (Gratis)
            </span>
          </label>

          <label class="shipping-radio">
            <input type="radio" name="tipo_entrega" value="despacho">
            <span class="radio-box">
              <span>üöö</span> Despacho a Domicilio
            </span>
          </label>
        </div>

        <div id="form-retiro" class="shipping-form" style="display: none;">
            <h4>Datos para el Retiro</h4>
            <div class="form-grid">
                <div class="form-group">
                    <label>Sucursal de Retiro</label>
                    <select id="retiro_sucursal" class="form-control">
                        <option value="">Cargando sucursales...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de Retiro (Disponible en 2 d√≠as)</label>
                    <input type="text" id="retiro_fecha" class="form-control flatpickr-input" placeholder="Selecciona fecha">
                </div>
                <div class="form-group">
                    <label>Nombre quien retira</label>
                    <input type="text" id="retiro_nombre" class="form-control" placeholder="Ej: Juan P√©rez">
                </div>
                <div class="form-group">
                    <label>RUT quien retira</label>
                    <input type="text" id="retiro_rut" class="form-control" placeholder="12.345.678-9">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="retiro_email" class="form-control">
                </div>
                <div class="form-group">
                    <label>Celular</label>
                    <input type="tel" id="retiro_celular" class="form-control" placeholder="+569...">
                </div>
            </div>
        </div>

        <div id="form-despacho" class="shipping-form" style="display: none;">
            <h4>Datos de Despacho</h4>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label>Regi√≥n</label>
                    <select id="select-region" class="form-control">
                        <option value="">Cargando regiones...</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label>Comuna / Ciudad</label>
                    <input type="text" id="input-comuna" class="form-control" placeholder="Escribe tu comuna (ej: Providencia, Vi√±a del Mar)">
                </div>
                
                <div class="form-group full-width">
                    <label>Direcci√≥n Exacta</label>
                    <input type="text" id="despacho_direccion" class="form-control" placeholder="Calle, N√∫mero, Depto/Casa">
                </div>
                
                <div class="info-box">
                    <span style="font-size: 1.5em;">üìÖ</span>
                    <div>
                        <strong>Fecha estimada de entrega:</strong> <span id="despacho_fecha_estimada">---</span><br>
                        <small>Plazo m√°ximo 7 d√≠as h√°biles desde la compra.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Horario de Entrega Preferente</label>
                    <select id="despacho_bloque" class="form-control">
                        <option value="10:00-12:00">10:00 - 12:00 hrs</option>
                        <option value="12:00-14:00">12:00 - 14:00 hrs</option>
                        <option value="14:00-16:00">14:00 - 16:00 hrs</option>
                        <option value="16:00-18:00">16:00 - 18:00 hrs</option>
                        <option value="18:00-20:00">18:00 - 20:00 hrs</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Nombre quien recibe</label>
                    <input type="text" id="despacho_nombre" class="form-control">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="despacho_email" class="form-control">
                </div>
                <div class="form-group">
                    <label>Celular</label>
                    <input type="tel" id="despacho_celular" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <div id="totals-container" class="cart-summary-box" style="display: none;">
        <div class="summary-row"><span>Subtotal Productos:</span> <span id="summary-subtotal">$0</span></div>
        <div class="summary-row"><span>Impuestos (IVA 19%):</span> <span id="summary-iva">$0</span></div>
        <div class="summary-row" style="color: #007bff;">
            <span>Costo de Env√≠o:</span> <span id="summary-envio">$0</span>
        </div>

        <div class="coupon-container">
            <label for="coupon-code" style="font-size: 0.9rem; font-weight: 600; display: block; margin-bottom: 5px;">¬øTienes un cup√≥n de descuento?</label>
            <div class="coupon-input-group">
                <input type="text" id="coupon-code" class="form-control" placeholder="Ingresa tu c√≥digo" style="text-transform: uppercase;">
                <button id="btn-apply-coupon" class="btn-coupon" type="button">Aplicar</button>
                <button id="btn-remove-coupon" class="btn-coupon remove" type="button" style="display: none;">Quitar</button>
            </div>
            <div id="coupon-msg"></div>
        </div>

        <div class="summary-row" id="row-discount" style="display: none; color: #28a745; font-weight: bold;">
            <span>Descuento:</span> <span id="summary-discount">-$0</span>
        </div>

        <div class="summary-total">
            <span>Total a Pagar:</span> <span id="summary-total">$0</span>
        </div>
        
        <div class="cart-buttons">
            <button class="btn-sm alt" id="btn-clear">Vaciar carrito</button>
            <button class="btn-sm" id="btn-checkout" type="button">Pagar con Webpay</button>
            <button class="btn-sm" id="btn-mp" type="button">Pagar con Mercado Pago</button>
        </div>
    </div>

  </div>
</main>

  <footer class="footer">
    <div class="container">
      <nav class="footer-top">
        <ul class="footer-menu">
          <li><a href="./sobre_nosotros.html">Sobre Nosotros</a></li>
          <li><a href="./envios.html">Env√≠os</a></li>
          <li><a href="./cambios_devoluciones.html">Cambios y Devoluciones</a></li>
          <li><a href="./contacto.html">Contacto</a></li>
          <li><a href="./sucursales.html">Sucursales</a></li>
        </ul>
      </nav>
    </div>
    <div class="footer-divider"></div>
    <div class="container">
      <div class="footer-bottom">
        <p>¬© 2025, Aurora-chile ¬∑ Moda y Belleza</p>
      </div>
    </div>
  </footer>

 <script>
document.addEventListener("DOMContentLoaded", () => {
  const p = new URLSearchParams(location.search);
  if (!p.has("success")) return;
  if (p.get("success") === "true") {
    alert(`‚úÖ Pago realizado. Orden: ${p.get("buy_order")}`);
  } else {
    alert("‚ùå El pago no se complet√≥.");
  }
  history.replaceState({}, "", location.pathname); 
});
</script>

<script>
(async function checkUserSessionAndSetupUI() {
  const adminBtnSpan = document.getElementById("admin-menu-btn");
  const perfilBtnSpan = document.getElementById("perfil-menu-btn"); 
  const welcomeMsg = document.getElementById("welcome-msg");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");

  if (adminBtnSpan) adminBtnSpan.style.display = "none";
  if (perfilBtnSpan) perfilBtnSpan.style.display = "none";
  if (welcomeMsg) welcomeMsg.style.display = "none";
  if (loginBtn) loginBtn.style.display = "inline-block";
  if (logoutBtn) logoutBtn.style.display = "none";

  try {
    const res = await fetch("http://localhost:5000/api/session_info", {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) { return; }

    const data = await res.json();

    if (data.logged_in) {
      if (welcomeMsg) {
        welcomeMsg.textContent = `Hola, ${data.nombre || ''} ${data.apellido_paterno || ''}`.trim();
        welcomeMsg.style.display = "inline";
      }
      if (loginBtn) loginBtn.style.display = "none";
      if (logoutBtn) logoutBtn.style.display = "inline-block";
      if (perfilBtnSpan) perfilBtnSpan.style.display = "inline"; 
      
      // Pre-llenar formulario de despacho si existen datos
      if(document.getElementById('despacho_nombre')) document.getElementById('despacho_nombre').value = `${data.nombre} ${data.apellido_paterno}`;
      if(document.getElementById('despacho_email')) document.getElementById('despacho_email').value = data.email;
      if(document.getElementById('retiro_nombre')) document.getElementById('retiro_nombre').value = `${data.nombre} ${data.apellido_paterno}`;
      if(document.getElementById('retiro_email')) document.getElementById('retiro_email').value = data.email;

      if (adminBtnSpan && (data.rol === "admin" || data.rol === "soporte")) {
        adminBtnSpan.style.display = "inline";
      }

    } else {
      if (perfilBtnSpan) perfilBtnSpan.style.display = "none"; 
    }

  } catch (err) {
    console.error("Error verificando sesi√≥n:", err);
  }

  if (logoutBtn && !logoutBtn.dataset.listenerAttached) {
    logoutBtn.addEventListener('click', () => {
      window.location.href = 'http://localhost:5000/logout';
    });
    logoutBtn.dataset.listenerAttached = 'true';
  }
})();
</script>

  <script type="module" src="/Public/Js/navigation.js"></script>
  <script type="module" src="/Public/Js/geolocation.js"></script>
  <script type="module" src="/Public/Js/colores.js"></script>
  
  <script type="module" src="../Public/js/carrito.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
<script type="module">
  import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

  createChat({
    webhookUrl: 'https://vicmoralesl.app.n8n.cloud/webhook/fd272f2c-66c0-4d7c-a04e-f239f0c90509/chat'
  });
</script>

<script type="module">
    const API_BACKEND = 'http://localhost:5000';
    const selectRegion = document.getElementById('select-region');
    
    async function cargarRegiones() {
        if (!selectRegion) return;
        try {
            const response = await fetch(`${API_BACKEND}/api/chilexpress/regiones`);
            if (!response.ok) throw new Error('Error al cargar regiones');
            const data = await response.json();
            
            selectRegion.innerHTML = '<option value="">Selecciona una regi√≥n</option>';
            if (data.regions) {
                data.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.regionName; 
                    option.textContent = region.regionName;
                    selectRegion.appendChild(option);
                });
            }
        } catch (error) { console.error(error); }
    }

    if (selectRegion) {
        selectRegion.addEventListener('change', () => {
            // Disparar evento para recalcular costo
            window.dispatchEvent(new CustomEvent('regionChanged', { detail: selectRegion.value }));
        });
    }

    cargarRegiones();
</script>

<script type="module">
  import { totalPrice } from '../Public/js/cart.js';
  // CAMBIO: IMPORTAR VALIDACI√ìN DESDE CARRITO.JS
  import { validarDatosEnvio } from '../Public/js/carrito.js';
  const $ = (s) => document.querySelector(s);

  // Variables de estado local para el cup√≥n
  let currentCoupon = null;

  function parseCLP(str) {
      // Elimina todo lo que no sea n√∫meros o signo menos, y convierte a n√∫mero
      return Number(String(str).replace(/[^0-9-]/g, '')) || 0;
  }

  function formatCLP(val) {
      return "$" + Math.round(val).toLocaleString("es-CL");
  }

  async function postJSON(url, body, options = {}) {
      const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
          ...options
      });
      const text = await r.text();
      if (!r.ok) {
          try {
              const errJson = JSON.parse(text);
              throw new Error(errJson.message || errJson.error || `HTTP ${r.status}`);
          } catch (e) {
              throw new Error(text.includes("<!doctype") ? "Error servidor" : text);
          }
      }
      return JSON.parse(text);
  }

  async function applyCoupon() {
      const input = $('#coupon-code');
      const msg = $('#coupon-msg');
      const codigo = input.value.trim();
      
      msg.textContent = "";
      msg.className = "";

      if (!codigo) {
          msg.textContent = "Ingresa un c√≥digo.";
          msg.style.color = "red";
          return;
      }

      const subtotal = totalPrice();
      const iva = Math.round(subtotal * 0.19);
      const totalProductosIVA = subtotal + iva;

      try {
          const response = await fetch("http://localhost:5000/api/validar-cupon", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ codigo, total: totalProductosIVA })
          });

          const data = await response.json();

          if (response.ok && data.valid) {
              currentCoupon = data;
              msg.textContent = data.message || "¬°Cup√≥n aplicado!";
              msg.style.color = "green";
              updateTotalsWithCoupon();
              
              $('#btn-apply-coupon').style.display = 'none';
              $('#btn-remove-coupon').style.display = 'inline-block';
              $('#coupon-code').disabled = true;
          } else {
              throw new Error(data.message || "Cup√≥n inv√°lido");
          }
      } catch (error) {
          msg.textContent = error.message;
          msg.style.color = "red";
          currentCoupon = null;
          updateTotalsWithCoupon();
      }
  }

  function removeCoupon() {
      currentCoupon = null;
      const input = $('#coupon-code');
      input.value = "";
      input.disabled = false;
      $('#btn-apply-coupon').style.display = 'inline-block';
      $('#btn-remove-coupon').style.display = 'none';
      $('#coupon-msg').textContent = "";
      updateTotalsWithCoupon();
  }

  // --- FUNCI√ìN DE C√ÅLCULO DIN√ÅMICO CORREGIDA ---
  function updateTotalsWithCoupon() {
      const subtotal = totalPrice();
      const iva = Math.round(subtotal * 0.19);
      
      // 1. OBTENER COSTO DE ENV√çO ACTUAL DESDE EL DOM
      const shippingElem = document.getElementById('summary-envio');
      const shippingCost = shippingElem ? parseCLP(shippingElem.innerText) : 0;

      // 2. TOTAL BASE PARA DESCUENTO: (Productos + IVA + Env√≠o) -> AHORA INCLUYE ENV√çO
      const totalWithShipping = subtotal + iva + shippingCost;

      // 3. CALCULAR DESCUENTO
      let discountAmount = 0;
      if (currentCoupon) {
          if (currentCoupon.tipo === 'pct') {
              // Aplicar porcentaje al total con env√≠o
              discountAmount = Math.round(totalWithShipping * (currentCoupon.valor / 100));
          } else {
              discountAmount = Math.round(currentCoupon.valor);
          }
          // Evitar descuento mayor al total
          if (discountAmount > totalWithShipping) discountAmount = totalWithShipping;
      }

      // 4. TOTAL FINAL
      const finalTotal = totalWithShipping - discountAmount;

      // 5. ACTUALIZAR UI
      if ($('#summary-subtotal')) $('#summary-subtotal').textContent = formatCLP(subtotal);
      if ($('#summary-iva')) $('#summary-iva').textContent = formatCLP(iva);
      
      const rowDiscount = $('#row-discount');
      if (rowDiscount) {
          if (currentCoupon) {
              rowDiscount.style.display = 'flex';
              
              // --- MOSTRAR TEXTO DE PORCENTAJE ---
              let discountText = `-${formatCLP(discountAmount)}`;
              if (currentCoupon.tipo === 'pct') {
                  discountText = `${Math.round(currentCoupon.valor)}% OFF | -${formatCLP(discountAmount)}`;
              }
              $('#summary-discount').textContent = discountText;
          } else {
              rowDiscount.style.display = 'none';
          }
      }
      
      if ($('#summary-total')) $('#summary-total').textContent = formatCLP(finalTotal);
      
      // Actualizar dataset para que Webpay/MP lean el total correcto
      const cartContainer = $('#cart-container');
      if (cartContainer) cartContainer.dataset.total = Math.round(finalTotal); 
      if ($('#totals-container')) $('#totals-container').dataset.total = Math.round(finalTotal);
  }

  // Listeners
  const btnApply = document.getElementById('btn-apply-coupon');
  if (btnApply) btnApply.addEventListener('click', applyCoupon);

  const btnRemove = document.getElementById('btn-remove-coupon');
  if (btnRemove) btnRemove.addEventListener('click', removeCoupon);

  // Escuchar cambios en el carrito (storage)
  window.addEventListener('storage', updateTotalsWithCoupon);

  // --- NUEVO: OBSERVADOR ROBUSTO PARA CAMBIOS EN EL COSTO DE ENV√çO ---
  // Observamos todo el contenedor del carrito para detectar re-renderizados o cambios en el env√≠o
  const cartContainer = document.getElementById('cart-container');
  if (cartContainer) {
      const observer = new MutationObserver((mutations) => {
          let shippingChanged = false;
          for (const mutation of mutations) {
             // Si el nodo #summary-envio fue afectado (texto o reemplazo)
             if (mutation.target.id === 'summary-envio' || 
                (mutation.target.parentElement && mutation.target.parentElement.id === 'summary-envio')) {
                 shippingChanged = true;
             }
          }
          if (shippingChanged) {
              updateTotalsWithCoupon();
          }
      });
      observer.observe(cartContainer, { childList: true, characterData: true, subtree: true });
  }

  // --- FUNCIONES DE PAGO USANDO EL TOTAL CALCULADO Y VALIDANDO ENV√çO ---

  async function handleWebpayCheckout() {
      // CAMBIO: 1. LLAMAR A LA VALIDACI√ìN ANTES DE NADA
      const datosEnvio = validarDatosEnvio();
      if (!datosEnvio) {
          return; // Detener si no hay datos de env√≠o o no se seleccion√≥ opci√≥n
      }

      // Leer el total FINAL del dataset actualizado por updateTotalsWithCoupon
      const cartContainer = $('#cart-container');
      const amount = cartContainer && cartContainer.dataset.total ? Number(cartContainer.dataset.total) : 0;
      
      if (!amount || amount <= 0) {
        alert("El total a pagar es inv√°lido."); return;
      }

      const btn = $('#btn-checkout');
      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = "Procesando...";

      try {
        const cartItems = (await import('../Public/js/cart.js')).getCart();
        if (!cartItems.length) throw new Error("Carrito vac√≠o");

        const currentSubtotal = totalPrice();
        const ivaCalculado = Math.round(currentSubtotal * 0.19);
        // sucursalId ya viene dentro de datosEnvio

        const pedidoParaCrear = {
            subtotal: currentSubtotal,
            iva: ivaCalculado,
            total: amount, // Total final con descuento
            id_cupon: currentCoupon ? currentCoupon.id_cupon : null,
            items: cartItems.map(item => ({ 
                sku: item.sku, qty: Number(item.qty), price: Number(item.price), stock: item.stock 
            })),
            // CAMBIO: Esparcir datos de env√≠o validados
            tipo_entrega: datosEnvio.tipo_entrega,
            costo_envio: datosEnvio.costo_envio,
            sucursal_id: datosEnvio.sucursal_id, 
            fecha_entrega: datosEnvio.fecha_entrega,
            bloque_horario: datosEnvio.bloque_horario,
            datos_contacto: datosEnvio.datos_contacto
        };

        localStorage.setItem('ultimaCompra', JSON.stringify({
            id: "PENDIENTE-" + Date.now(),
            fecha: new Date().toLocaleString('es-CL'),
            ...pedidoParaCrear,
            descuento_aplicado: currentCoupon,
            items: cartItems.map(item => ({ 
                sku: item.sku, title: item.name, qty: Number(item.qty), price: Number(item.price), image: item.image, variation: item.variation 
            }))
        }));

        const respPedido = await postJSON("http://localhost:5000/api/crear-pedido", pedidoParaCrear, { credentials: "include" });
        const id_pedido_nuevo = respPedido.id_pedido;
        
        const compraGuardada = JSON.parse(localStorage.getItem('ultimaCompra'));
        compraGuardada.id = id_pedido_nuevo;
        localStorage.setItem('ultimaCompra', JSON.stringify(compraGuardada));

        const sessionIdWebpay = "USR-" + Date.now();
        const data = await postJSON("http://localhost:3010/webpay/create", {
            amount: amount, 
            buyOrder: id_pedido_nuevo, 
            sessionId: sessionIdWebpay
        });

        if (!data?.token || !data?.url) throw new Error("Error respuesta Webpay");
        window.location.href = `${data.url}?token_ws=${data.token}`;

      } catch (error) {
        console.error(error);
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = oldText;
      }
  }

  async function handleMercadoPagoCheckout() {
      // CAMBIO: 1. VALIDACI√ìN TAMBI√âN AQU√ç
      const datosEnvio = validarDatosEnvio();
      if (!datosEnvio) return;

      const cartContainer = $('#cart-container');
      const amount = cartContainer && cartContainer.dataset.total ? Number(cartContainer.dataset.total) : 0;
      
      if (!amount || amount <= 0) { alert("Error total."); return; }

      const btn = $('#btn-mp');
      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = "Procesando...";

      try {
        const cartItems = (await import('../Public/js/cart.js')).getCart();
        const subtotal = totalPrice();
        const ivaCalculado = Math.round(subtotal * 0.19);

        const pedidoParaCrear = {
            subtotal: subtotal,
            iva: ivaCalculado,
            total: amount,
            id_cupon: currentCoupon ? currentCoupon.id_cupon : null,
            items: cartItems.map(item => ({ sku: item.sku, qty: Number(item.qty), price: Number(item.price), stock: item.stock })),
            // CAMBIO: Esparcir datos de env√≠o validados
            tipo_entrega: datosEnvio.tipo_entrega,
            costo_envio: datosEnvio.costo_envio,
            sucursal_id: datosEnvio.sucursal_id, 
            fecha_entrega: datosEnvio.fecha_entrega,
            bloque_horario: datosEnvio.bloque_horario,
            datos_contacto: datosEnvio.datos_contacto
        };

        localStorage.setItem('ultimaCompra', JSON.stringify({
            id: "PENDIENTE-MP-" + Date.now(),
            fecha: new Date().toLocaleString('es-CL'),
            ...pedidoParaCrear,
            descuento_aplicado: currentCoupon,
            items: cartItems.map(item => ({ sku: item.sku, title: item.name, qty: Number(item.qty), price: Number(item.price), image: item.image, variation: item.variation }))
        }));

        const respPedido = await postJSON("http://localhost:5000/api/crear-pedido", pedidoParaCrear, { credentials: "include" });
        const id_pedido_nuevo = respPedido.id_pedido;

        const compraGuardada = JSON.parse(localStorage.getItem('ultimaCompra'));
        compraGuardada.id = id_pedido_nuevo;
        localStorage.setItem('ultimaCompra', JSON.stringify(compraGuardada));

        const mpUrl = "http://localhost:3010/mercadopago/create_preference";
        const itemsForMp = [{
            id: "TOTAL",
            title: "Compra en Aurora" + (currentCoupon ? ` (Desc: ${currentCoupon.codigo})` : ""),
            unit_price: amount,
            quantity: 1,
            currency_id: "CLP"
        }];

        const mpData = await postJSON(mpUrl, { 
            items: itemsForMp, 
            amount: amount,
            external_reference: id_pedido_nuevo
        });

        const next = mpData.init_point || mpData.sandbox_init_point;
        if (!next) throw new Error("Respuesta inv√°lida MP");
        window.location.href = next;

      } catch(e) {
        console.error(e);
        alert("Error: " + e.message);
        btn.disabled = false;
        btn.textContent = "Pagar con Mercado Pago";
    }
}

  const btnCheckout = document.getElementById('btn-checkout');
  if (btnCheckout) btnCheckout.addEventListener('click', (e) => { e.preventDefault(); handleWebpayCheckout(); });

  const btnMp = document.getElementById('btn-mp');
  if (btnMp) btnMp.addEventListener('click', (e) => { e.preventDefault(); handleMercadoPagoCheckout(); });

</script>
</html>